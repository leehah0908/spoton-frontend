import React, { useContext, useEffect, useRef, useState } from 'react';
import axiosInstance from '../../configs/axios-config';
import { useLocation } from 'react-router-dom';
import { Box, Button, Container, TextField, Typography } from '@mui/material';
import AuthContext from '../../contexts/UserContext';
import { Stomp } from '@stomp/stompjs';
import NanumDetail from '../modals/NanumDetail';
import axios from 'axios';

const NanumChat = () => {
    const { userEmail } = useContext(AuthContext);

    // Ï±ÑÌåÖ Ï†ïÎ≥¥ Î†åÎçîÎßÅÏùÑ ÎßâÍ∏∞ ÏúÑÌï¥ Ref ÏÇ¨Ïö©
    const stompClient = useRef(null);

    // Î©îÏÑ∏ÏßÄ ÏµúÏã†Ìôî
    const messagesEndRef = useRef(null);
    const [isConnected, setIsConnected] = useState(false);

    // ÎÇòÎàî DetailÏóêÏÑú Î∞õÏïÑÏò® Id Í∏∞Î≥∏ ÏÑ∏ÌåÖ
    const location = useLocation();
    const fromDetailRoomId = location.state?.chatRoom;

    const [roomId, setRoomId] = useState(fromDetailRoomId);
    const [chatType, setChatType] = useState('receiver');

    const [chatList, setChatList] = useState([]);
    const [inputMessage, setInputMessage] = useState('');

    const [detailModalOpen, setDetailModalOpen] = useState(false);
    const [selectedId, setSelectedId] = useState(null);

    useEffect(() => {
        setRoomId('');
        const initializeWebSocket = async () => {
            sessionStorage.removeItem('gameState');

            // ÏÜåÏºì Ï¥àÍ∏∞Ìôî
            // const socket = new WebSocket('wss://api.onspoton.com/chat');
            const socket = new WebSocket('ws://localhost:8181/chat');
            const client = Stomp.over(socket);
            stompClient.current = client;

            client.connect({}, async () => {
                setIsConnected(true);

                try {
                    // Ï±ÑÌåÖ Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
                    const rooms = await chatListLoadData();

                    for (const room of rooms) {
                        // Ïù¥Ï†Ñ Ï±ÑÌåÖ ÎÇ¥Ïó≠ ÏÑ∏ÌåÖ
                        const res = await axiosInstance.post('/chat/nanum_chat/message', {
                            roomId: room.nanumChatRoomId,
                        });

                        // Ï±ÑÌåÖ Î¶¨Ïä§Ìä∏ ÏÑ∏ÌåÖ
                        setChatList((prev) =>
                            prev.map((chatRoom) => {
                                if (chatRoom.nanumChatRoomId === room.nanumChatRoomId) {
                                    return {
                                        ...chatRoom,
                                        messages: res.data.result,
                                    };
                                }
                                return chatRoom;
                            }),
                        );

                        // Ï∞∏Ïó¨ Ï±ÑÌåÖ Îã§Ï§ë Íµ¨ÎèÖ
                        client.subscribe(`/sub/chat/nanum_chat/${room.nanumChatRoomId}`, (message) => {
                            const parsedMessage = JSON.parse(message.body);
                            handleIncomingMessage(parsedMessage);
                        });
                    }
                } catch (e) {
                    console.error('ÏõπÏÜåÏºì Ïó∞Í≤∞ Ïã§Ìå®');
                }
            });
        };

        initializeWebSocket();

        // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú ÏõπÏÜåÏºì Ïó∞Í≤∞ Ìï¥Ï†ú
        return () => {
            if (stompClient.current) {
                stompClient.current.disconnect();
                setIsConnected(false);
            }
        };
    }, [chatType]);

    // ÏÑ∏Î°úÏö¥ Î©îÏÑ∏ÏßÄ ÏÉùÏÑ±Ïãú
    const handleIncomingMessage = (message) => {
        // Ï±ÑÌåÖ Î¶¨Ïä§Ìä∏Ïùò ÎßàÏßÄÎßâ Î©îÏÑ∏ÏßÄ ÎÇ¥Ïó≠ Í∞±Ïã†
        setChatList((prev) => {
            return prev.map((room) => {
                if (room.nanumChatRoomId === message.nanumChatRoomId) {
                    return {
                        ...room,
                        lastMessage: message.content,
                        lastMessageTime: message.createTime,
                        messages: [...room.messages, message],
                    };
                }
                return room;
            });
        });
    };

    // ÏÉàÎ°úÏö¥ Ï±ÑÌåÖÏù¥ ÏûàÏùÑ Îïå Ïä§ÌÅ¨Î°§ Îß® Î∞ëÏúºÎ°ú Ïù¥Îèô
    useEffect(() => {
        scrollToBottom();
    }, [chatList]);

    // Ï±ÑÌåÖÎ∞©Ïóê Îì§Ïñ¥Í∞à Îïå Ïä§ÌÅ¨Î°§ Îß® Î∞ëÏúºÎ°ú Ïù¥Îèô
    useEffect(() => {
        if (roomId) {
            scrollToBottom();
        }
    }, [roomId]);

    // Ï±ÑÌåÖ Î™©Î°ù Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞
    const chatListLoadData = async () => {
        try {
            const res = await axiosInstance.get('/chat/nanum_chat/list', { params: { chatType } });
            setChatList(res.data.result);
            return res.data.result;
        } catch (e) {
            console.log('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®', e);
        }
    };

    // Ï±ÑÌåÖÎ∞© Î≥ÄÍ≤ΩÏãú
    const handleRoomClick = (roomId) => {
        setRoomId(roomId);
    };

    // Ï†ÑÏó≠ Ï±ÑÌåÖ Î©îÏÑ∏ÏßÄÎ°ú Î≥¥ÎÇ¥Í∏∞
    const sendMessage = () => {
        if (isConnected && inputMessage) {
            const body = {
                roomId,
                email: userEmail,
                content: inputMessage,
            };

            stompClient.current.send(`/pub/chat/nanum_chat`, {}, JSON.stringify(body));
            setInputMessage('');
        } else {
            console.error('Î©îÏÑ∏ÏßÄ Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
    };

    // ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÍ∞Ä ÏÉùÍ∏∏ Îïå Ïä§ÌÅ¨Î°§ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
    const scrollToBottom = () => {
        if (messagesEndRef.current) {
            messagesEndRef.current.scrollTop = messagesEndRef.current.scrollHeight;
        }
    };

    // ÎÇòÎàîÍ∏Ä ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÏöîÏ≤≠
    const handleOpenDetailModal = async (id) => {
        try {
            await axios.post(
                `${process.env.REACT_APP_BASE_URL}/nanum/view`,
                {},
                {
                    params: {
                        nanumId: id,
                    },
                },
            );
        } catch (e) {
            console.log('Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä Ïã§Ìå®');
        }

        setSelectedId(id);
        setDetailModalOpen(true);
    };

    const handleCloseDetailModal = () => {
        setDetailModalOpen(false);
    };

    return (
        <Container maxWidth='lg'>
            <Box>
                <Typography variant='h6' sx={{ fontWeight: '500', display: 'flex', mt: 3, pl: 2, mb: 0.5 }}>
                    üó®Ô∏è Ï±ÑÌåÖ Î™©Î°ù
                </Typography>
            </Box>

            {isConnected ? (
                <Box display='flex' sx={{ height: '80vh', overflow: 'hidden', mt: 3 }}>
                    {/* Ï±ÑÌåÖ Î™©Î°ù */}
                    <Box width='30%' borderRight='1px solid #ddd' sx={{ overflowY: 'auto' }}>
                        <Box
                            display='flex'
                            flexDirection='row'
                            justifyContent='center'
                            alignItems='center'
                            gap={2}
                            sx={{ borderBottom: '1px solid #ddd', bgcolor: '#f9f9f9', p: 1.3 }}
                        >
                            <Button
                                variant='outlined'
                                sx={{
                                    fontSize: 18,
                                    bgcolor: chatType === 'receiver' ? 'rgba(13, 66, 225, 0.1)' : 'white',
                                    color: chatType === 'receiver' ? '#0d41e1' : '#7D7D7D',
                                    borderColor: chatType === 'receiver' ? '#0d41e1' : '#D4D4D8',
                                }}
                                onClick={() => setChatType('receiver')}
                            >
                                Íµ¨Îß§ Ï±ÑÌåÖ
                            </Button>

                            <Button
                                variant='outlined'
                                sx={{
                                    fontSize: 18,
                                    bgcolor: chatType === 'provider' ? 'rgba(13, 66, 225, 0.1)' : 'white',
                                    color: chatType === 'provider' ? '#0d41e1' : '#7D7D7D',
                                    borderColor: chatType === 'provider' ? '#0d41e1' : '#D4D4D8',
                                }}
                                onClick={() => setChatType('provider')}
                            >
                                ÌåêÎß§ Ï±ÑÌåÖ
                            </Button>
                        </Box>

                        {chatList.length !== 0 ? (
                            <Box>
                                {chatList.map((chat, index) => (
                                    <Box
                                        display='flex'
                                        flexDirection='row'
                                        key={index}
                                        button
                                        selected={roomId === chat.nanumChatRoomId}
                                        onClick={() => handleRoomClick(chat.nanumChatRoomId)}
                                        sx={{
                                            bgcolor: roomId === chat.nanumChatRoomId ? 'rgba(13, 66, 225, 0.1)' : 'white',
                                            borderBottom: '1px solid #f5f5f5',
                                            p: 1.5,
                                            pl: 2,
                                            cursor: 'pointer',
                                        }}
                                    >
                                        <img
                                            src={
                                                chatType === 'provider'
                                                    ? chat.receiver.profile
                                                    : chat.provider.profile || 'default_profile.png'
                                            }
                                            alt='ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ'
                                            style={{ width: 50, height: 50, borderRadius: 50, objectFit: 'cover' }}
                                        />

                                        <Box display='flex' flexDirection='column' sx={{ width: '100%' }}>
                                            <Box
                                                display='flex'
                                                flexDirection='row'
                                                alignItems='center'
                                                justifyContent='space-between'
                                            >
                                                <Typography sx={{ ml: 2 }}>
                                                    {chatType === 'provider' ? chat.receiver.nickname : chat.provider.nickname}
                                                </Typography>

                                                <Typography sx={{ ml: 2, fontSize: 13, color: 'gray' }}>
                                                    {chat.lastMessageTime.substr(0, 10).replace(/-/g, '/')}{' '}
                                                    {chat.lastMessageTime.substr(11, 5)}
                                                </Typography>
                                            </Box>

                                            <Typography sx={{ ml: 2, fontSize: 15, color: 'gray', alignSelf: 'flex-start' }}>
                                                {chat.lastMessage}
                                            </Typography>
                                        </Box>
                                    </Box>
                                ))}
                            </Box>
                        ) : (
                            <Box>
                                <Typography sx={{ fontSize: 20, color: 'gray', mt: 3 }}>Ï∞∏Ïó¨Ï§ëÏù∏ Ï±ÑÌåÖÎ∞©Ïù¥ ÏóÜÏäµÎãàÎã§.</Typography>
                            </Box>
                        )}
                    </Box>

                    {/* Ï±ÑÌåÖ ÌôîÎ©¥ */}
                    {chatList && roomId ? (
                        <Box flex={1} display='flex' flexDirection='column' width='70%'>
                            {/* Ï±ÑÌåÖÎ∞© Ï†úÎ™© */}
                            <Box
                                display='flex'
                                flexDirection='row'
                                onClick={() =>
                                    handleOpenDetailModal(chatList.find((item) => item.nanumChatRoomId === roomId).nanum.nanumId)
                                }
                                sx={{
                                    p: 2,
                                    borderBottom: '1px solid #ddd',
                                    backgroundColor: '#f9f9f9',
                                    cursor: 'pointer',
                                    alignItems: 'flex-end',
                                }}
                            >
                                {console.log(chatList)}
                                <img
                                    src={`${process.env.REACT_APP_NANUM_IMAGE_URL}/${encodeURIComponent(chatList.find((item) => item.nanumChatRoomId === roomId).nanumImage.normalize('NFD'))}`}
                                    alt='Ïç∏ÎÑ§Ïùº ÏÇ¨ÏßÑ'
                                    style={{ width: 70, height: 70, borderRadius: 10, objectFit: 'cover' }}
                                />

                                <Box sx={{ ml: 2, mb: 0.5 }}>
                                    <Typography sx={{ fontSize: 20 }}>
                                        {chatList.find((item) => item.nanumChatRoomId === roomId).nanum.subject}
                                    </Typography>

                                    <Box display='flex' flexDirection='row'>
                                        <Typography sx={{ color: 'gray' }}>
                                            {chatList.find((item) => item.nanumChatRoomId === roomId).nanum.quantity}Í∞ú
                                        </Typography>
                                        <Typography sx={{ ml: 1, color: 'gray' }}>
                                            {chatList.find((item) => item.nanumChatRoomId === roomId).nanum.status}
                                        </Typography>
                                        <Typography sx={{ ml: 1, color: 'gray' }}>
                                            (
                                            {chatList.find((item) => item.nanumChatRoomId === roomId).nanum.giveMethod ===
                                            'delivery'
                                                ? 'ÌÉùÎ∞∞ ÏàòÎ†π'
                                                : 'ÏßÅÏ†ë ÏàòÎ†π'}
                                            )
                                        </Typography>
                                    </Box>
                                </Box>
                            </Box>

                            {/* Î©îÏãúÏßÄ Î¶¨Ïä§Ìä∏ */}
                            <Box
                                ref={messagesEndRef}
                                gap={1}
                                sx={{
                                    flex: 1,
                                    m: 1.5,
                                    mr: 0,
                                    pr: 1.5,
                                    display: 'flex',
                                    flexDirection: 'column',
                                    overflowY: 'auto',
                                }}
                            >
                                {chatList
                                    .find((item) => item.nanumChatRoomId === roomId)
                                    .messages.map((message) =>
                                        message.email === userEmail ? (
                                            <Box
                                                key={message.messagId}
                                                display='flex'
                                                flexDirection='row'
                                                justifyContent='flex-end'
                                                sx={{
                                                    maxWidth: '70%',
                                                    alignSelf: 'flex-end',
                                                    p: 1,
                                                    px: 1.5,
                                                }}
                                            >
                                                <Box
                                                    sx={{
                                                        display: 'flex',
                                                        flexDirection: 'row',
                                                        alignItems: 'flex-end',
                                                    }}
                                                >
                                                    <Typography sx={{ fontSize: 12, mr: 1, color: 'gray' }}>
                                                        {message.createTime.substr(0, 10).replace(/-/g, '/')}{' '}
                                                        {message.createTime.substr(11, 5)}
                                                    </Typography>

                                                    <Box
                                                        sx={{
                                                            py: 1,
                                                            px: 1.5,
                                                            bgcolor: '#D8ECFF',
                                                            borderRadius: 2,
                                                        }}
                                                    >
                                                        <Typography
                                                            sx={{
                                                                fontSize: 15,
                                                                fontWeight: '600',
                                                                fontFamily: 'Noto Sans Korean',
                                                            }}
                                                        >
                                                            {message.content}
                                                        </Typography>
                                                    </Box>
                                                </Box>
                                            </Box>
                                        ) : (
                                            <Box
                                                key={message.messagId}
                                                display='flex'
                                                flexDirection='row'
                                                justifyContent='flex-end'
                                                sx={{
                                                    maxWidth: '70%',
                                                    alignSelf: 'flex-start',
                                                    p: 1,
                                                    px: 1.5,
                                                }}
                                            >
                                                <Box
                                                    sx={{
                                                        display: 'flex',
                                                        flexDirection: 'row',
                                                        alignItems: 'flex-end',
                                                    }}
                                                >
                                                    <Box
                                                        sx={{
                                                            py: 1,
                                                            px: 1.5,
                                                            bgcolor: '#F0F1F4',
                                                            borderRadius: 2,
                                                        }}
                                                    >
                                                        <Typography
                                                            sx={{
                                                                fontSize: 15,
                                                                fontWeight: '600',
                                                                fontFamily: 'Noto Sans Korean',
                                                            }}
                                                        >
                                                            {message.content}
                                                        </Typography>
                                                    </Box>

                                                    <Typography sx={{ fontSize: 12, ml: 1, color: 'gray' }}>
                                                        {message.createTime.substr(0, 10).replace(/-/g, '/')}{' '}
                                                        {message.createTime.substr(11, 5)}
                                                    </Typography>
                                                </Box>
                                            </Box>
                                        ),
                                    )}
                            </Box>

                            {/* Î©îÏãúÏßÄ ÏûÖÎ†• */}
                            <Box sx={{ display: 'flex', alignItems: 'center', p: 1, borderTop: '1px solid gray' }}>
                                <TextField
                                    variant='outlined'
                                    value={inputMessage}
                                    onChange={(e) => setInputMessage(e.target.value)}
                                    placeholder='Î©îÏÑ∏ÏßÄ Î≥¥ÎÇ¥Í∏∞'
                                    onKeyDown={(e) => {
                                        if (e.keyCode === 229) return;
                                        if (e.key === 'Enter') {
                                            e.preventDefault();
                                            sendMessage();
                                        }
                                    }}
                                    sx={{ flex: 1 }}
                                />
                                <Button
                                    variant='contained'
                                    sx={{ ml: 2, fontSize: 18, p: 1.5, px: 3, bgcolor: '#0d41e1' }}
                                    onClick={sendMessage}
                                >
                                    Î≥¥ÎÇ¥Í∏∞
                                </Button>
                            </Box>
                        </Box>
                    ) : (
                        <Box width='70%'>
                            {/* Ï±ÑÌåÖÎ∞© Ï†úÎ™© */}
                            <Box sx={{ p: 2, borderBottom: '1px solid #ddd', backgroundColor: '#f9f9f9' }}>
                                <Typography variant='h6'>Ï±ÑÌåÖÎ∞©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</Typography>
                            </Box>
                        </Box>
                    )}
                </Box>
            ) : (
                <Box width='70%'>
                    <Box sx={{ p: 2, borderBottom: '1px solid #ddd', backgroundColor: '#f9f9f9' }}>
                        <Typography variant='h6'>Ï±ÑÌåÖÎ∞©ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</Typography>
                        <Typography variant='h6'>Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</Typography>
                    </Box>
                </Box>
            )}

            <NanumDetail
                open={detailModalOpen}
                onClose={handleCloseDetailModal}
                setDetailModalOpen={setDetailModalOpen}
                nanumId={selectedId}
                setNanumId={setSelectedId}
            />
        </Container>
    );
};

export default NanumChat;
